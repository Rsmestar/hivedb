# خدمة الذاكرة السائلة (Liquid Cache)

خدمة الذاكرة السائلة هي نظام تخزين مؤقت ذكي مصمم لتحسين أداء استعلامات قاعدة البيانات في HiveDB. تستخدم هذه الخدمة تقنيات متقدمة للتنبؤ بأنماط الاستعلامات المستقبلية وتخزين البيانات الأكثر استخدامًا في الذاكرة المؤقتة.

## المميزات الرئيسية

- **تخزين مؤقت متعدد الطبقات**: تستخدم طبقات مختلفة للتخزين المؤقت مع سياسات مختلفة للاحتفاظ بالبيانات.
- **التعرف على أنماط الاستعلامات**: تتعلم أنماط الاستعلامات الشائعة وتستخدمها للتنبؤ بالاستعلامات المستقبلية.
- **التحميل المسبق الذكي**: تقوم بتحميل البيانات المتوقع استخدامها في المستقبل بناءً على أنماط الاستخدام السابقة.
- **إدارة تلقائية للذاكرة**: تقوم بإزالة العناصر الأقل استخدامًا عندما تمتلئ الذاكرة المؤقتة.
- **حفظ أنماط الاستعلامات**: تحفظ أنماط الاستعلامات عند إيقاف التشغيل وتحميلها عند بدء التشغيل.

## كيفية الاستخدام

### الحصول على بيانات من الذاكرة المؤقتة

```python
# توليد مفتاح للذاكرة المؤقتة
cache_key = liquid_cache._generate_key("cell_data", {
    "cell_key": cell_key,
    "data_key": key,
    "user_id": str(current_user.id)
})

# التحقق مما إذا كانت النتيجة موجودة في الذاكرة المؤقتة
cached_result = liquid_cache.get(cache_key)
if cached_result:
    return cached_result
```

### تخزين بيانات في الذاكرة المؤقتة

```python
# تخزين النتيجة في الذاكرة المؤقتة
liquid_cache.set(cache_key, response)
```

### تسجيل نمط استعلام

```python
# تسجيل نمط استعلام للتعلم
liquid_cache.register_query("cell_query", {
    "cell_key": cell_key,
    "query_type": query_types
})
```

### إبطال عناصر الذاكرة المؤقتة

```python
# إبطال عناصر الذاكرة المؤقتة المتعلقة بخلية معينة
cache_keys_to_invalidate = liquid_cache.find_related_keys(f"cell_{cell_key}")
for cache_key in cache_keys_to_invalidate:
    liquid_cache.invalidate(cache_key)
```

## واجهة API للإدارة

تتوفر نقاط نهاية API التالية لإدارة الذاكرة السائلة:

- `GET /admin/cache/stats`: الحصول على إحصائيات مفصلة عن الذاكرة السائلة.
- `POST /admin/cache/clear`: مسح الذاكرة السائلة بالكامل.
- `GET /admin/cache/hints`: الحصول على تلميحات للبيانات التي يجب تحميلها مسبقًا في الذاكرة المؤقتة.
- `POST /admin/cache/preload`: تحميل البيانات الأكثر استخدامًا مسبقًا في الذاكرة المؤقتة.

## متغيرات البيئة

يمكن تكوين خدمة الذاكرة السائلة باستخدام متغيرات البيئة التالية:

- `LIQUID_CACHE_ENABLED`: لتمكين أو تعطيل الذاكرة السائلة (القيمة الافتراضية: `True`).
- `LIQUID_CACHE_SIZE`: الحد الأقصى لعدد العناصر في الذاكرة المؤقتة (القيمة الافتراضية: `1000`).
- `LIQUID_CACHE_TTL`: مدة صلاحية عناصر الذاكرة المؤقتة بالثواني (القيمة الافتراضية: `3600`).
- `LIQUID_CACHE_PREDICTION_THRESHOLD`: الحد الأدنى لعدد مرات تكرار النمط قبل استخدامه للتنبؤ (القيمة الافتراضية: `3`).
- `LIQUID_CACHE_LAYERS`: عدد طبقات الذاكرة المؤقتة (القيمة الافتراضية: `3`).

## ملاحظات أمنية

- تقوم الذاكرة السائلة بتخزين البيانات في الذاكرة فقط ولا تقوم بتخزينها على القرص.
- يتم تشفير البيانات الحساسة قبل تخزينها في الذاكرة المؤقتة إذا كان SGX ممكّنًا.
- يتم التحقق من صلاحيات المستخدم قبل إرجاع البيانات من الذاكرة المؤقتة.
